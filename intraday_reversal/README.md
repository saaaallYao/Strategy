# Intraday Reversal Strategies for A-Shares — V1 & V2 (T+1)

## 概览（Overview）
本文档说明两套基于**尾盘 30 分钟反转**的日内/隔夜策略，用于 A 股（T+1）市场：

- **V1：T 15:00 进场 → T+1 14:56 离场**  
  - 信号窗口：**14:26 → 14:56**（当日最后 30 分钟）  
  - 执行：当日 **15:00（收盘集合竞价）** 等权买入 **TOP5** 当日尾盘跌幅居前股票；次日 **14:56** 等权卖出。
- **V2：T 14:46 进场 → T+1 14:56 离场**  
  - 信号窗口：**14:16 → 14:46**（严格早于进场时间 14:46 的 30 分钟）  
  - 执行：当日 **14:46** 等权买入 **TOP5** 当日 14:16→14:46 跌幅居前股票；次日 **14:56** 等权卖出。

两策略均为**逆势（contrarian）尾盘反转**思路：在信号窗口内跌得最狠的股票，次日存在均值回归的机会。基准（Buy&Hold）为**同窗口等权**收益（即按当日进场价持有到次日 14:56 的等权篮子）。

---

## 输入与输出（I/O）
- **输入**：分钟线 ZIP（已在脚本内写死路径）  
  `ZIP_PATH = "/mnt/data/b35591cb-478c-4c51-816e-f3d122df5f04.zip"`  
  ZIP 中每只股票以 CSV 存储，字段要求至少包含：`symbol, timestamp, close`（无 `open` 时会自动以 `close` 代替）。
- **输出**（每个策略一个目录）  
  - `metrics.csv`：含 Train / Test / Full 的时间段与指标  
  - `trade_log.csv`：逐笔交易（进出时间、价格、收益等）  
  - （可选核查图）`equity.png`, `trading_frequency.png`

> 如需在本地运行，请将脚本中的 `ZIP_PATH` 改为你的 ZIP 绝对/相对路径。

---

## 数据与预处理（Data & Preprocessing）
- 时间戳解析为本地交易日，按分钟对齐；信号与交易严格使用**精确分钟**：14:16、14:26、14:46、14:56、15:00。  
- 如某分钟缺失则该股票当日**不参与**（避免插值引入前视偏差）。  
- 当日有效股票数量须 ≥ TOPK 才会下单；否则**跳过**该交易日。  
- 所有收益在**退出日（T+1）**入账。  

---

## 交易规则（Trading Rules）
**共同设置**
- 选股：按信号窗口收益从低到高排序，取 **TOPK = 5**（可改）。
- 权重：等权（对所选股票平均分配资金）。
- 成本：**每边 0.03%**（`cost_per_side=0.0003`），每次完整进出记一次往返成本。
- 计价：全部使用分钟收盘价（对应精确分钟）。
- T+1：当日买入后**隔夜持有**，次日 14:56 统一卖出；无当日内回转。

**V1（集合竞价进场）**
- 信号：T 日 **14:26→14:56** 的 30 分钟收益。
- 进场：T 日 **15:00（收盘集合竞价）**。
- 出场：T+1 日 **14:56**。

**V2（盘中 14:46 进场）**
- 信号：T 日 **14:16→14:46** 的 30 分钟收益（**严格早于进场时间**，避免前视）。
- 进场：T 日 **14:46**（连续竞价时段）。
- 出场：T+1 日 **14:56**。

---

## 指标定义（Metrics）
对**日频收益序列**（以 T+1 入账）计算：
- **Annual Return**：年化收益率。  
- **Sharpe**：以日频为单位，\( \text{Sharpe} = \sqrt{252}\cdot\frac{\mu}{\sigma} \)。  
- **Max Drawdown（MDD）**：权益曲线相对历史峰值的最深回撤。  
- **MAR**：年化收益 / |MDD|。  
- **Monthly Win Rate**：按月聚合收益为正的月份占比。

并分别给出 **Train（前 70% 样本）**、**Test（后 30% 样本）**、**Full（全样本）**三组指标。

---

## 回测流程（Backtest Pipeline）
1. **对齐分钟价表**：从 ZIP 中读取每只股票 CSV，提取指定分钟（14:16/14:26/14:46/14:56/15:00）的收盘价，构造日期×股票矩阵。  
2. **生成信号**：信号 = `px_sigB / px_sigA - 1`（对应两端分钟价）。  
3. **选股与建仓**：每日按信号从低到高选 **TOP5** 建多仓；V1 于 **15:00** 进场，V2 于 **14:46** 进场。  
4. **隔夜与平仓**：持有至 **T+1 14:56** 卖出。  
5. **费用与盈亏**：日收益 = 选股平均收益 − 往返成本。  
6. **基准构造**：同一交易日对**全体可交易股票**做“进场分钟 → 次日 14:56”的等权收益，作为 Buy&Hold（EW，同窗）。  
7. **切分与统计**：按时间先后 7:3 切分 Train/Test，输出各阶段指标与交易清单。

---

## 与 A 股交易规则的匹配（Regulatory Compliance）
- **T+1**：当日买入后不在当日内卖出，次日 14:56 统一卖出，符合 A 股 T+1。  
- **无未来函数**：V1 与 V2 的信号窗口均**不包含**进场时点之后的任何价；V1 在 15:00 入场，信号止于 14:56；V2 在 14:46 入场，信号止于 14:46 之前。  
- **集合竞价与连续竞价**：V1 使用收盘集合竞价价（15:00）；V2 使用盘中连续竞价价（14:46）。  

> 注意：实盘需处理涨跌停不可交易、停牌、异常撮合、异动风控、价格滑点与成交量约束等。当前回测按分钟收盘价撮合，未考虑滑点与限价失败。

---

## 关键参数（Key Parameters）
| 参数 | V1 | V2 |
|---|---|---|
| 信号窗口 | 14:26 → 14:56 | 14:16 → 14:46 |
| 进场时间 | 15:00（集合竞价） | 14:46（盘中） |
| 出场时间 | 次日 14:56 | 次日 14:56 |
| TOPK | 5 | 5 |
| 成本/边 | 0.03% | 0.03% |
| 权重 | 等权 | 等权 |

---

## 产出文件（Per-Strategy Outputs）
- `metrics.csv`：列包含  
  `Label, Set, Span, Days, AnnRet, Sharpe, MaxDD, MAR, WinRateM`  
  - 其中 `Label` 为策略名称（或 Buy&Hold），`Set` 为 Train/Test/Full。  
- `trade_log.csv`：列包含  
  `trade_date, symbol, entry_day, entry_time, entry_px, exit_day, exit_time, exit_px, ret`

---

## 运行方式（How to Run）
已经提供两份**内嵌 ZIP 路径**的脚本（无需命令行参数）：

- V1：`run_strategy_V1_ziphard.py`  
- V2：`run_strategy_V2_ziphard.py`

直接运行脚本，会在脚本同级生成：
- `outputs_V1_ziphard/` 或 `outputs_V2_ziphard/`  
  - `metrics.csv`, `trade_log.csv`  
  - `equity.png`, `trading_frequency.png`（可选核查图）

如需改用你本地的 ZIP 数据，请直接编辑脚本顶部：
```python
ZIP_PATH = "path/to/your_data.zip"
```

---

## 已知局限（Limitations）
- **分钟对齐依赖**：若某分钟数据缺失，当日会跳过该股票，可能造成样本波动。  
- **未建模滑点与成交量**：实际成交价与分钟收盘价存在偏差，且大额委托可能冲击价格。  
- **涨跌停/停牌**：遇到一字板或停牌，进出可能无法按价成交；当前回测未模拟该情形。  
- **风控**：未设置单票/行业/市值/波动率等维度的暴露约束。

---

## 版权与用途（Disclaimer）
本策略及回测代码仅用于研究与教育目的，不构成任何投资建议。请在遵循当地法律与交易所规则的前提下谨慎使用。
